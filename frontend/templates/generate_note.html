{% extends "base.html" %}

{% block title %}Generate Note with AI - Note Taking App{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ü§ñ Generate Note with AI</h1>
    <p class="subtitle">Describe what you want to note in natural language</p>
</div>

<div class="form-container">
    <!-- Input Form -->
    <div id="inputForm" class="generate-form">
        <div class="form-group">
            <label for="description">Describe what you want to note (in natural language):</label>
            <textarea id="description" class="form-textarea" rows="6" placeholder='Example: "Badminton tmr 5pm @polyu" or "Meeting with John about Q1 budget on Friday"' autofocus></textarea>
            <small class="form-help">Be brief and natural. AI will extract and structure it into a complete note with title, full sentences, and tags (max 3).</small>
            <div class="examples-hint">
                <strong>üí° Try these examples:</strong>
                <ul>
                    <li>"Dentist appointment next Tuesday 3pm"</li>
                    <li>"Buy milk eggs bread at supermarket"</li>
                    <li>"Project deadline Friday need to finish report"</li>
                    <li>"Gym workout 6am Monday chest and arms"</li>
                </ul>
            </div>
        </div>

        <div class="form-group">
            <label for="outputLanguage">Output Language:</label>
            <select id="outputLanguage" class="form-select">
                <option value="English">English</option>
                <option value="Chinese">Chinese (‰∏≠Êñá)</option>
            </select>
        </div>

        <div class="form-actions">
            <button type="button" class="btn-primary" onclick="generateNote()" id="generateBtn">
                <span class="btn-icon">‚ú®</span> Generate
            </button>
            <a href="{{ url_for('index') }}" class="btn-secondary">Cancel</a>
        </div>
    </div>

    <!-- Preview Section (Hidden by default) -->
    <div id="previewSection" class="preview-section" style="display: none;">
        <div class="preview-header">
            <h2>üìù Generated Note Preview</h2>
        </div>

        <div class="preview-content">
            <div class="form-group">
                <label>Title:</label>
                <input type="text" id="previewTitle" class="form-input" readonly>
            </div>

            <div class="form-group">
                <label>Content:</label>
                <div id="previewContent" class="preview-text"></div>
            </div>

            <div class="form-group">
                <label>Tags (max 3):</label>
                <div id="previewTags" class="preview-tags"></div>
            </div>

            <div class="form-group" id="previewDateTimeGroup" style="display: none;">
                <label>üìÖ Event Date & Time:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="date" id="previewEventDate" class="form-input" style="flex: 1;">
                    <input type="time" id="previewEventTime" class="form-input" style="flex: 1;">
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="btn-primary" onclick="saveNote()">
                <span class="btn-icon">üíæ</span> Save Note
            </button>
            <button type="button" class="btn-secondary" onclick="regenerate()">
                <span class="btn-icon">üîÑ</span> Regenerate
            </button>
            <button type="button" class="btn-secondary" onclick="cancelGeneration()">Cancel</button>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>ü§ñ AI is generating your note...</p>
            <small>This may take a few seconds</small>
        </div>
    </div>
</div>

<style>
.generate-form {
    animation: fadeIn 0.3s ease-in;
}

.preview-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    animation: slideIn 0.4s ease-out;
}

.preview-header h2 {
    color: white;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.preview-content {
    background: white;
    padding: 24px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.preview-text {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 6px;
    min-height: 100px;
    white-space: pre-wrap;
    line-height: 1.6;
    border: 1px solid #dee2e6;
}

.preview-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.preview-tag {
    background: #e3f2fd;
    color: #1976d2;
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 0.9rem;
    font-weight: 500;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease-in;
}

.loading-content {
    background: white;
    padding: 40px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.btn-icon {
    font-size: 1.1rem;
}

.form-help {
    color: #6c757d;
    font-size: 0.9rem;
    margin-top: 4px;
    display: block;
}

.examples-hint {
    background: #f8f9fa;
    border-left: 4px solid #667eea;
    padding: 12px 16px;
    margin-top: 12px;
    border-radius: 4px;
}

.examples-hint strong {
    color: #667eea;
    display: block;
    margin-bottom: 8px;
}

.examples-hint ul {
    margin: 0;
    padding-left: 20px;
    font-size: 0.9rem;
    color: #495057;
}

.examples-hint li {
    margin-bottom: 4px;
    line-height: 1.5;
}
</style>

{% endblock %}

{% block scripts %}
<script>
let generatedNoteData = null;

async function generateNote() {
    const description = document.getElementById('description').value.trim();
    const language = document.getElementById('outputLanguage').value;
    
    if (!description) {
        alert('Please describe what you want to note');
        return;
    }
    
    // Show loading
    document.getElementById('loadingIndicator').style.display = 'flex';
    
    // Disable button
    const btn = document.getElementById('generateBtn');
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/generate-note', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                description: description,
                language: language
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            generatedNoteData = data.note;
            showPreview(data.note);
        } else {
            alert('Failed to generate note: ' + data.error);
            btn.disabled = false;
        }
    } catch (error) {
        alert('Error: ' + error.message);
        btn.disabled = false;
    } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

function showPreview(note) {
    // Populate preview
    document.getElementById('previewTitle').value = note.title;
    document.getElementById('previewContent').textContent = note.content;
    
    // Display tags
    const tagsContainer = document.getElementById('previewTags');
    tagsContainer.innerHTML = '';
    
    if (note.tags) {
        const tags = note.tags.split(',').map(t => t.trim()).filter(t => t);
        tags.forEach(tag => {
            const tagSpan = document.createElement('span');
            tagSpan.className = 'preview-tag';
            tagSpan.textContent = tag;
            tagsContainer.appendChild(tagSpan);
        });
    }
    
    // Display date and time if available
    const dateTimeGroup = document.getElementById('previewDateTimeGroup');
    const eventDateInput = document.getElementById('previewEventDate');
    const eventTimeInput = document.getElementById('previewEventTime');
    
    if (note.event_date || note.event_time) {
        dateTimeGroup.style.display = 'block';
        eventDateInput.value = note.event_date || '';
        eventTimeInput.value = note.event_time || '';
    } else {
        dateTimeGroup.style.display = 'none';
        eventDateInput.value = '';
        eventTimeInput.value = '';
    }
    
    // Hide input form, show preview
    document.getElementById('inputForm').style.display = 'none';
    document.getElementById('previewSection').style.display = 'block';
}

async function saveNote() {
    if (!generatedNoteData) {
        alert('No note to save');
        return;
    }
    
    // Show loading
    document.getElementById('loadingIndicator').style.display = 'flex';
    
    try {
        // Get updated date and time from inputs (user can modify them)
        const eventDate = document.getElementById('previewEventDate').value || '';
        const eventTime = document.getElementById('previewEventTime').value || '';
        
        // Save note to database
        const formData = new FormData();
        formData.append('title', generatedNoteData.title);
        formData.append('content', generatedNoteData.content);
        formData.append('tags', generatedNoteData.tags);
        formData.append('category', ''); // Empty by default
        formData.append('event_date', eventDate);
        formData.append('event_time', eventTime);
        
        const response = await fetch('/add', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success && data.note_id) {
            // Redirect to edit page for the newly created note
            window.location.href = `/edit/${data.note_id}`;
        } else {
            alert('Failed to save note');
            document.getElementById('loadingIndicator').style.display = 'none';
        }
    } catch (error) {
        alert('Error saving note: ' + error.message);
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

function regenerate() {
    // Reset and regenerate
    document.getElementById('previewSection').style.display = 'none';
    document.getElementById('inputForm').style.display = 'block';
    document.getElementById('generateBtn').disabled = false;
    generatedNoteData = null;
}

function cancelGeneration() {
    if (confirm('Are you sure you want to cancel? The generated note will be lost.')) {
        window.location.href = '/';
    }
}
</script>
{% endblock %}
