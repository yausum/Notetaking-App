{% extends "base.html" %}

{% block title %}{{ note['title'] }} - Note Taking App{% endblock %}

{% block content %}
<div class="note-view">
    <div class="note-header">
        <div>
            <h1 class="note-title-large">{{ note['title'] }}</h1>
            <div class="note-metadata">
                {% if note['category'] %}
                    <span class="category-badge-large">{{ note['category'] }}</span>
                {% endif %}
                {% if note['tags'] %}
                    <div class="tags-container">
                        {% for tag in note['tags'].split(',') %}
                            <span class="tag-badge">{{ tag.strip() }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
                {% if note['event_date'] or note['event_time'] %}
                    <div class="event-info">
                        <span class="event-icon">üìÖ</span>
                        {% if note['event_date'] %}
                            <span class="event-date">{{ note['event_date'] }}</span>
                        {% endif %}
                        {% if note['event_time'] %}
                            <span class="event-time">üïê {{ note['event_time'] }}</span>
                        {% endif %}
                    </div>
                {% endif %}
                <span class="note-date-large">Created: {{ note['created_at'] }}</span>
                {% if note['updated_at'] != note['created_at'] %}
                    <span class="note-date-large">Updated: {{ note['updated_at'] }}</span>
                {% endif %}
            </div>
        </div>
        <div class="note-header-actions">
            <a href="{{ url_for('edit_note', id=note['id']) }}" class="btn-primary">Edit</a>
            <button class="btn-secondary" onclick="showTranslateModal()">üåê Translate</button>
            <button class="btn-danger" onclick="confirmDelete({{ note['id'] }})">Delete</button>
        </div>
    </div>

    <div class="note-content-display" id="noteContent">
        {{ note['content']|replace('\n', '<br>')|safe }}
    </div>

    <!-- Translation Display -->
    <div id="translationResult" class="translation-result" style="display: none;">
        <div class="translation-header">
            <h3>Translation</h3>
            <button class="btn-small" onclick="closeTranslation()">‚úï</button>
        </div>
        <div class="translation-content" id="translatedContent"></div>
    </div>

    <div class="note-footer">
        <a href="{{ url_for('index') }}" class="btn-back">‚Üê Back to Notes</a>
    </div>
</div>

<form id="deleteForm" method="POST" style="display: none;">
</form>
{% endblock %}

{% block scripts %}
<script>
const originalContent = {{ note['content']|tojson }};

function confirmDelete(noteId) {
    if (confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
        const form = document.getElementById('deleteForm');
        form.action = `/delete/${noteId}`;
        form.submit();
    }
}

function showTranslateModal() {
    const languages = ['Chinese', 'English', 'Spanish', 'French', 'German', 'Japanese', 'Korean'];
    const language = prompt('Enter target language:\n' + languages.join(', '), 'Chinese');
    
    if (language) {
        translateNote(language);
    }
}

async function translateNote(targetLanguage) {
    const translationResult = document.getElementById('translationResult');
    const translatedContent = document.getElementById('translatedContent');
    
    // Show loading
    translationResult.style.display = 'block';
    translatedContent.innerHTML = '<div class="loading">üîÑ Translating to ' + targetLanguage + '...</div>';
    
    try {
        const response = await fetch('/api/translate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                text: originalContent,
                target_language: targetLanguage
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            translatedContent.innerHTML = '<p>' + data.translated.replace(/\n/g, '<br>') + '</p>';
        } else {
            translatedContent.innerHTML = '<div class="error">‚ùå Translation failed: ' + data.error + '</div>';
        }
    } catch (error) {
        translatedContent.innerHTML = '<div class="error">‚ùå Error: ' + error.message + '</div>';
    }
}

function closeTranslation() {
    document.getElementById('translationResult').style.display = 'none';
}
</script>
{% endblock %}
